<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tesla Stock Trading</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e8/Tesla_logo.png" type="image/png" />
  <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e8/Tesla_logo.png" />
  <meta name="theme-color" content="#cc0000" />
  <!-- Leaflet CSS (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* ... previous CSS ... */
    #osmMap { width: 100%; height: 210px; border-radius: 6px; }
  </style>
</head>
<body>
  <img src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Tesla_logo.png" alt="Tesla Logo" class="tesla-logo" />

  <div id="authPage" class="auth-page">
    <div class="auth-choice">
      <button onclick="showAuth('register')">Register Account</button>
      <button onclick="showAuth('login')">Already Registered? Login</button>
    </div>
    <div id="regSection" class="auth-section active">
      <h2>Register for Tesla Private Trading</h2>
      <div id="regError" class="error-msg"></div>
      <form onsubmit="event.preventDefault(); register();">
        <label for="regFullName">Full Name</label>
        <input type="text" id="regFullName" placeholder="Full Name" required />
        <label for="regUsername">Username</label>
        <input type="text" id="regUsername" placeholder="Username" required />
        <label for="regEmail">Email</label>
        <input type="email" id="regEmail" placeholder="Email" required />
        <label for="regPhone">Phone</label>
        <input type="tel" id="regPhone" placeholder="Phone Number" required />
        <label for="regPassword">Password</label>
        <input type="password" id="regPassword" placeholder="Password" required />
        <label for="regReferral">Tesla Private Referral ID</label>
        <input type="text" id="regReferral" placeholder="Referral ID" required />
        <label for="regLocation">Residential Location (City, State/Country)</label>
        <input type="text" id="regLocation" placeholder="e.g. Berlin, Germany" required />
        <button type="submit">Register</button>
      </form>
    </div>
    <div id="loginSection" class="auth-section">
      <h2>Login to Your Tesla Account</h2>
      <div id="loginError" class="error-msg"></div>
      <div id="specialLoginInfo" class="special-login-info">
        For exclusive Tesla MODEL S delivery tracking, login with<br>
        <span class="special-login-hash">Phone: <b>+4915234072276</b> &mdash; Referral ID: <b>962081</b> &mdash; Hash-ID: <b>[ 0196-6324-8349 ]</b></span>
      </div>
      <form onsubmit="event.preventDefault(); login();">
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Username" required />
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
    </div>
  </div>

  <div id="dashboard" style="display:none;">
    <!-- ... dashboard content ... -->
    <div class="footer">
      Tesla Licence Â® 2025 &mdash; All Rights Reserved<br>
      Tesla, Inc. | Headquarters: 3500 Deer Creek Road, Palo Alto, CA, USA<br>
      Gigafactory Berlin, Germany | <a href="https://www.tesla.com/de_DE/gigafactory-berlin" target="_blank" style="color:#cc0000;text-decoration:underline;">Learn More</a>
    </div>
  </div>

  <!-- Spin Modal -->
  <div id="spinModal" class="spin-modal">
    <div class="spin-content">
      <div class="spin-arrow">â–²</div>
      <div class="spin-wheel" id="spinWheel"></div>
      <div class="spin-prize" id="spinPrize"></div>
      <button id="spinBtn" onclick="spinTheWheel()">Spin</button>
    </div>
  </div>

  <!-- Delivery Modal with OpenStreetMap -->
  <div id="deliveryModal" class="delivery-modal">
    <div class="delivery-content">
      <div class="delivery-title">
        <button class="delivery-bell-btn" onclick="beepBell()" title="Tesla Delivery Bell">ðŸ””</button>
        TESLA MODEL S DELIVERY STATUS
      </div>
      <div id="deliveryBeep" class="delivery-bell-beep">Bell Beep! ðŸšš</div>
      <div class="delivery-process-info">
        <span id="deliveryInfo"></span>
      </div>
      <div id="deliveryWait" class="delivery-process-wait">Processing... Please wait for confirmation.</div>
      <div id="deliveryDone" class="delivery-process-done" style="display:none;">ORDER SUCCESSFULLY REVIEWED AND DELIVERY ðŸšš HAS STARTED</div>
      <div id="deliveryMap" class="delivery-map" style="display:none;">
        <div class="map-header">TESLA HQ âž” Coburg, Germany</div>
        <div id="osmMap"></div>
      </div>
      <div id="deliveryTrackInfo" class="delivery-track-info" style="display:none;">
        Use TESLA VERIFICATION HASH-ID <b>[ 0196-6324-8349 ]</b> to track your delivery towards your destination.
      </div>
    </div>
  </div>

  <!-- Leaflet JS (OpenStreetMap) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let users = {};
    let currentUser = null;
    const TESLA_REF_ID = "962081";
    const TESLA_VERIF_HASH = "0196-6324-8349";
    const SPECIAL_PHONE = "+4915234072276";
    const spinItems = [
      "CYBER TRUCK",
      "$50,000 BTC",
      "WORKER LICENSE",
      "TAX REFUND",
      "$4,000 WEB3 TRADE COUPONS"
    ];
    let deliveryTimer = null;
    let deliveryStarted = false;
    let osmMapInstance = null;

    function showAuth(section) {
      document.getElementById('regSection').classList.remove('active');
      document.getElementById('loginSection').classList.remove('active');
      if (section === 'register') {
        document.getElementById('regSection').classList.add('active');
      } else {
        document.getElementById('loginSection').classList.add('active');
        document.getElementById('specialLoginInfo').style.display = "block";
      }
      document.getElementById('regError').style.display = "none";
      document.getElementById('loginError').style.display = "none";
    }

    function register() {
      const fullName = document.getElementById("regFullName").value.trim();
      const username = document.getElementById("regUsername").value.trim();
      const email = document.getElementById("regEmail").value.trim().toLowerCase();
      const phone = document.getElementById("regPhone").value.trim();
      const password = document.getElementById("regPassword").value;
      const refID = document.getElementById("regReferral").value.trim();
      const location = document.getElementById("regLocation").value.trim();
      const errorDiv = document.getElementById('regError');
      errorDiv.style.display = 'none';

      if (!fullName || !username || !email || !phone || !password || !refID || !location) {
        errorDiv.textContent = "All fields are required.";
        errorDiv.style.display = 'block';
        return;
      }
      if (refID !== TESLA_REF_ID) {
        errorDiv.textContent = "TESLA IS A PRIVATE COMPANY. You need the special ID to register.";
        errorDiv.style.display = 'block';
        return;
      }
      if (users[username] || Object.values(users).some(u => u.email === email || u.phone === phone)) {
        errorDiv.textContent = "This username, email, or phone number has already been registered.";
        errorDiv.style.display = 'block';
        return;
      }
      users[username] = { fullName, username, email, phone, password, refID, location };
      currentUser = users[username];
      document.getElementById("authPage").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      updateDashboardUser();
      triggerFirstGiftOrDelivery();
    }

    function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      const errorDiv = document.getElementById('loginError');
      errorDiv.style.display = 'none';

      let foundUser = users[username];
      if (!username || !password) {
        errorDiv.textContent = "Please enter both username and password.";
        errorDiv.style.display = 'block';
        return;
      }
      if (foundUser && foundUser.password === password) {
        currentUser = foundUser;
        document.getElementById("authPage").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        updateDashboardUser();
        if (
          (foundUser.phone === SPECIAL_PHONE || foundUser.email === SPECIAL_PHONE || foundUser.username === SPECIAL_PHONE) &&
          foundUser.refID === TESLA_REF_ID
        ) {
          showDeliveryModal(foundUser);
        } else {
          showSpinModal();
        }
      } else {
        errorDiv.textContent = "Invalid login credentials.";
        errorDiv.style.display = 'block';
      }
    }

    function updateDashboardUser() {
      document.getElementById("userDisplay").textContent =
        `${currentUser.fullName} (${currentUser.username})`;
    }

    function applyJob(jobName) {
      alert(`Your application for the position "${jobName}" is being processed securely.\nA Tesla HR representative will contact you via provided details.\nThank you for applying!`);
      window.open("https://wa.me/qr/W4BIEGPNPIZDH1", "_blank");
    }

    function triggerFirstGiftOrDelivery() {
      showSpinModal();
    }

    let spinning = false;

    function showSpinModal() {
      spinning = false;
      document.getElementById("spinModal").style.display = "flex";
      document.getElementById("spinPrize").textContent = "";
      document.getElementById("spinBtn").disabled = false;
      renderWheel();
    }

    function spinTheWheel() {
      if (spinning) return;
      spinning = true;
      document.getElementById("spinBtn").disabled = true;
      let cycles = 12 + Math.floor(Math.random() * 4);
      let finalIndex = spinItems.length - 1;
      let i = 0;
      function animateSpin() {
        let item = spinItems[i % spinItems.length];
        document.getElementById("spinWheel").textContent = item;
        i++;
        if (i < cycles) {
          setTimeout(animateSpin, 80 + i*8);
        } else {
          document.getElementById("spinWheel").textContent = spinItems[finalIndex];
          document.getElementById("spinPrize").textContent =
            `$4,000 WEB3 TRADE COUPONS will be added to your TRADE ACCOUNT once you activate it.`;
          setTimeout(() => {
            document.getElementById("spinModal").style.display = "none";
          }, 3400);
        }
      }
      animateSpin();
    }

    function renderWheel() {
      document.getElementById("spinWheel").textContent = spinItems[0];
      document.getElementById("spinPrize").textContent = "Spin to win your welcome prize!";
      document.getElementById("spinBtn").disabled = false;
    }

    function showDeliveryModal(user) {
      deliveryStarted = false;
      document.getElementById("deliveryModal").style.display = "flex";
      document.getElementById("deliveryBeep").style.display = "none";
      document.getElementById("deliveryWait").style.display = "block";
      document.getElementById("deliveryDone").style.display = "none";
      document.getElementById("deliveryMap").style.display = "none";
      document.getElementById("deliveryTrackInfo").style.display = "none";
      // Use user's location or fallback
      const userLocation = user.location || "Coburg, Germany";
      document.querySelector('.map-header').textContent = `TESLA HQ âž” ${userLocation}`;
      startDeliveryTimer(userLocation);
    }

    // Geocode any address worldwide using Nominatim
    function geocodeLocation(address, callback) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.length > 0) {
            callback([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
          } else {
            callback([50.2600, 10.9639]); // fallback: Coburg
          }
        })
        .catch(() => {
          callback([50.2600, 10.9639]);
        });
    }

    function startDeliveryTimer(userLocation) {
      let waitTime = 1800000;
      if (location.hostname === "localhost") waitTime = 8000;
      if (deliveryTimer) clearTimeout(deliveryTimer);
      deliveryTimer = setTimeout(() => deliveryProcessStart(userLocation), waitTime);
    }

    function deliveryProcessStart(userLocation) {
      deliveryStarted = true;
      document.getElementById("deliveryWait").style.display = "none";
      document.getElementById("deliveryDone").style.display = "block";
      document.getElementById("deliveryMap").style.display = "block";
      document.getElementById("deliveryTrackInfo").style.display = "block";
      setTimeout(() => initOsmMap(userLocation), 300);
    }

    function initOsmMap(userLocation) {
      geocodeLocation(userLocation, function(destCoords) {
        if (osmMapInstance) {
          osmMapInstance.remove();
          osmMapInstance = null;
        }
        osmMapInstance = L.map('osmMap', {
          center: [ (37.3947 + destCoords[0])/2, (-122.1503 + destCoords[1])/2 ],
          zoom: 4,
          zoomControl: false,
          attributionControl: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(osmMapInstance);

        // Tesla HQ marker
        const teslaHQ = L.marker([37.3947, -122.1503]).addTo(osmMapInstance);
        teslaHQ.bindPopup("Tesla HQ<br>Palo Alto, CA, USA").openPopup();

        // User marker
        const userMarker = L.marker(destCoords).addTo(osmMapInstance);
        userMarker.bindPopup(`${userLocation}`);

        // Route
        const route = [
          [37.3947, -122.1503],
          destCoords
        ];
        L.polyline(route, {color: '#cc0000', weight: 4, dashArray: '10,6', opacity: 0.8}).addTo(osmMapInstance);

        // Fit bounds
        osmMapInstance.fitBounds([
          [37.3947, -122.1503],
          destCoords
        ], {padding: [16,16]});
      });
    }

    function beepBell() {
      document.getElementById("deliveryBeep").style.display = "block";
      setTimeout(() => {
        document.getElementById("deliveryBeep").style.display = "none";
      }, 1500);
    }

    showAuth('register');
  </script>
</body>
</html>
